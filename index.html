<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clipboard Manager (Rewritten v3)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',system-ui,sans-serif;}
    body{background:#f3f4f6;min-height:100vh;}
    .container{display:flex;height:100vh;padding:10px;gap:10px;}

    /* Left panel */
    .add-panel-wrapper{position:relative;transition:width .25s;}
    .add-panel{width:270px;background:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 8px rgba(0,0,0,.1);height:100%;display:flex;flex-direction:column;overflow-y:auto;transition:all .25s ease;}
    .add-panel.collapsed{width:0;padding:0;overflow:hidden;box-shadow:none;}
    .collapse-toggle{position:absolute;top:10px;right:-16px;width:16px;height:60px;background:#111827;color:#fff;border-radius:0 6px 6px 0;display:flex;align-items:center;justify-content:center;font-size:10px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3);z-index:10;}
    .collapse-toggle i{transition:transform .2s;}
    .add-panel.collapsed ~ .collapse-toggle i{transform:rotate(180deg);}
    .collapse-toggle.pulse{animation:togglePulse 2s infinite;}
    @keyframes togglePulse{0%,100%{background:#111827;}50%{background:#6366f1;}}

    .panel-title{display:flex;align-items:center;gap:6px;margin-bottom:8px;font-size:1rem;font-weight:700;color:#111827;}
    .mode-label{font-size:.75rem;color:#6b7280;margin-bottom:6px;}
    .edit-info{font-size:.75rem;color:#10b981;margin-bottom:6px;display:none;}

    label{display:block;margin:8px 0 4px;font-size:.8rem;font-weight:700;color:#4b5563;}

    .resizable-input-wrapper{position:relative;margin-bottom:8px;}
    textarea{width:100%;border-radius:6px;border:2px solid #e5e7eb;padding:8px;font-size:13px;resize:both;overflow:auto;}
    textarea:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 2px rgba(99,102,241,.2);}
    .resize-icon{position:absolute;right:6px;bottom:6px;color:#9ca3af;font-size:10px;pointer-events:none;}

    .color-options{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin:6px 0 8px;}
    .color-option{width:26px;height:26px;border-radius:6px;cursor:pointer;border:2px solid transparent;}
    .color-option.selected{border-color:#111827;}
    .custom-color{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
    .custom-color input[type=color]{width:44px;height:30px;border:none;border-radius:6px;cursor:pointer;}

    .btn{background:linear-gradient(to right,#6366f1,#4f46e5);border:none;color:#fff;padding:8px 10px;border-radius:6px;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;}
    .btn.secondary{background:#e5e7eb;color:#111827;}
    .btn.save{background:linear-gradient(to right,#059669,#047857);}

    .quick-buttons{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;}
    .quick-btn{background:#f9fafb;border:1px solid #e5e7eb;font-size:11px;padding:6px 6px;border-radius:6px;cursor:pointer;}

    .hint{margin-top:10px;font-size:.75rem;color:#6b7280;line-height:1.35;}

    /* Board */
    .board{flex:1;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);position:relative;overflow:hidden;}

    .clipboard-item{position:absolute;min-width:100px;min-height:40px;width:140px;height:60px;border-radius:6px;padding:6px 8px;cursor:grab;display:flex;align-items:flex-start;justify-content:flex-start;color:#fff;font-size:12px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.15);user-select:none;}
    .clipboard-item:active{cursor:grabbing;}
    .clipboard-item.selected{outline:2px solid #facc15;}
    .item-heading{max-width:100%;white-space:pre-wrap;word-wrap:break-word;overflow:hidden;line-height:1.3;padding-top:2px;}
    .resize-handle{position:absolute;width:10px;height:10px;right:2px;bottom:2px;background:rgba(0,0,0,.4);border-radius:2px;cursor:se-resize;}
    .delete-btn{position:absolute;right:2px;top:2px;width:18px;height:18px;border-radius:50%;border:none;font-size:10px;background:rgba(0,0,0,.4);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .copy-indicator{position:absolute;left:4px;top:4px;padding:2px 4px;border-radius:3px;background:rgba(16,185,129,.9);color:#fff;font-size:9px;opacity:0;transition:opacity .2s;}
    .clipboard-item.copied .copy-indicator{opacity:1;}

    /* Alignment guides (Canva-like) */
    .align-guides{position:absolute;inset:0;pointer-events:none;z-index:4000;}
    .guide-line{position:absolute;background:rgba(99,102,241,.85);display:none;}
    .guide-line.v{width:1px;top:0;bottom:0;}
    .guide-line.h{height:1px;left:0;right:0;}
    .guide-line.show{display:block;}

    /* Notifications */
    .notification{position:fixed;right:20px;bottom:20px;background:#10b981;color:#fff;padding:8px 12px;border-radius:6px;font-size:.85rem;display:flex;gap:8px;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.2);opacity:0;transform:translateY(60px);transition:all .25s;z-index:2000;}
    .notification.show{opacity:1;transform:translateY(0);}

    /* Small "Copied" toast near clicked item */
    .copy-toast{position:fixed;z-index:6000;pointer-events:none;background:#111827;color:#fff;font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;box-shadow:0 6px 18px rgba(0,0,0,.18);opacity:0;transform:translateY(4px);transition:opacity .12s ease, transform .12s ease;}
    .copy-toast.show{opacity:1;transform:translateY(0);}

    /* Multi copy panel */
    .multi-copy-panel{position:fixed;right:10px;top:50%;transform:translateY(-50%);width:240px;max-height:80vh;background:rgba(255,255,255,.95);border-radius:8px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,.15);display:none;flex-direction:column;z-index:1500;border:1px solid #e5e7eb;cursor:move;}
    .multi-copy-panel.active{display:flex;}
    .multi-panel-header{font-size:11px;font-weight:800;color:#111827;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;gap:6px;cursor:move;}
    .multi-items-list{flex:1;overflow-y:auto;margin-bottom:8px;max-height:500px;cursor:default;}
    .multi-item{background:#f9fafb;border:1px solid #e5e7eb;border-radius:4px;padding:6px 8px;margin-bottom:6px;font-size:10px;color:#374151;word-break:break-word;line-height:1.4;white-space:pre-wrap;font-family:Consolas,Monaco,monospace;}
    .multi-clear-btn{background:#ef4444;color:#fff;border:none;padding:6px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:800;}

    .btn.multi-toggle-btn{background:#10b981;}
    .btn.multi-toggle-btn.active{background:#ef4444;}

    /* Floating buttons */
    .floating-buttons{position:fixed;right:10px;top:20px;display:flex;gap:10px;z-index:1600;}
    .float-btn{width:50px;height:50px;border:none;border-radius:8px;color:#fff;font-size:18px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;transition:transform .15s, box-shadow .15s;}
    .float-btn:hover{transform:scale(1.06);box-shadow:0 6px 16px rgba(0,0,0,.25);}
    .float-save{background:#059669;}
    .float-multi{background:#10b981;}
    .float-multi.active{background:#ef4444;}

    /* Context menu */
    .context-menu{position:fixed;background:#fff;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.25);padding:6px 0;min-width:180px;z-index:5000;display:none;border:1px solid #e5e7eb;}
    .context-menu.show{display:block;}
    .ctx-item{padding:9px 12px;font-size:13px;color:#111827;cursor:pointer;display:flex;align-items:center;gap:10px;}
    .ctx-item:hover{background:#f3f4f6;}
    .ctx-item i{width:16px;color:#6b7280;font-size:12px;}
    .ctx-sep{height:1px;background:#e5e7eb;margin:6px 0;}
    .ctx-item.danger{color:#b91c1c;}
    .ctx-item.danger i{color:#b91c1c;}
    .ctx-item.danger:hover{background:#fee2e2;}
  </style>
</head>
<body>
  <div class="container">
    <div class="add-panel-wrapper">
      <div class="add-panel" id="addPanel">
        <div class="panel-title"><i class="fas fa-clipboard-list"></i>Clipboard Manager</div>
        <div class="mode-label" id="modeLabel">Mode: Add new</div>
        <div class="edit-info" id="editInfo">Editing Box ID: <span id="editId"></span></div>

        <label>Heading (optional - shown on box)</label>
        <div class="resizable-input-wrapper">
          <textarea id="headingInput" rows="2" placeholder="e.g. Email Address\nCan add multiple lines"></textarea>
          <i class="fas fa-grip-lines-vertical resize-icon"></i>
        </div>

        <label>Content (what to copy)</label>
        <div class="resizable-input-wrapper">
          <textarea id="contentInput" rows="3" placeholder="Enter the text to copy..." autocomplete="off"></textarea>
          <i class="fas fa-grip-lines-vertical resize-icon"></i>
        </div>

        <label>Pick Color</label>
        <div class="color-options" id="colorOptions">
          <div class="color-option selected" data-color="#6366f1" style="background:#6366f1"></div>
          <div class="color-option" data-color="#ec4899" style="background:#ec4899"></div>
          <div class="color-option" data-color="#f59e0b" style="background:#f59e0b"></div>
          <div class="color-option" data-color="#10b981" style="background:#10b981"></div>
          <div class="color-option" data-color="#3b82f6" style="background:#3b82f6"></div>
          <div class="color-option" data-color="#8b5cf6" style="background:#8b5cf6"></div>
        </div>

        <div class="custom-color">
          <input type="color" id="customColor" value="#6366f1">
          <span style="font-size:.75rem;color:#6b7280;">Custom Hex</span>
        </div>

        <button class="btn" id="addBtn"><i class="fas fa-plus"></i>Add new box</button>
        <button class="btn secondary" id="updateBtn" disabled><i class="fas fa-pen"></i>Update selected box</button>
        <button class="btn save" id="saveFileBtn"><i class="fas fa-save"></i>Save to HTML File</button>
        <button class="btn multi-toggle-btn" id="multiCopyBtn"><i class="fas fa-layer-group"></i>Multi Copy</button>

        <div class="mode-label" style="margin-top:8px;">Quick Actions</div>
        <div class="quick-buttons">
          <button class="quick-btn" data-heading="Email" data-content="user@email.com">Email</button>
          <button class="quick-btn" data-heading="API Key" data-content="API_KEY_123">API</button>
          <button class="quick-btn" data-heading="Password" data-content="Pass@123">Password</button>
          <button class="quick-btn" data-heading="Phone" data-content="+123456789">Phone</button>
        </div>

        <div class="hint">
          Ctrl+Enter to add • Click box to copy & edit • Right-click for menu • Ctrl+Shift+X to clear all • Panel auto-hides after 5s
        </div>
      </div>

      <div class="collapse-toggle" id="collapseToggle" title="Show/Hide panel">
        <i class="fas fa-chevron-left"></i>
      </div>
    </div>

    <div class="board" id="board">
      <div class="align-guides" id="alignGuides">
        <div class="guide-line v" id="guideV"></div>
        <div class="guide-line h" id="guideH"></div>
      </div>
    </div>
  </div>

  <div class="notification" id="notification">Ready</div>
  <div class="copy-toast" id="copyToast">Copied</div>

  <div class="floating-buttons">
    <button class="float-btn float-save" id="saveFloatToggle" title="Save to HTML"><i class="fas fa-save"></i></button>
    <button class="float-btn float-multi" id="multiFloatToggle" title="Multi Copy"><i class="fas fa-layer-group"></i></button>
  </div>

  <div class="multi-copy-panel" id="multiCopyPanel">
    <div class="multi-panel-header" id="multiPanelHeader"><i class="fas fa-layer-group" style="font-size:10px"></i><span>Combined Copy</span></div>
    <div class="multi-items-list" id="multiItemsList"></div>
    <button class="multi-clear-btn" id="multiClearBtn">Clear All</button>
  </div>

  <div class="context-menu" id="contextMenu">
    <div class="ctx-item" data-action="copy"><i class="fas fa-copy"></i><span>Copy content</span></div>
    <div class="ctx-item" data-action="edit"><i class="fas fa-pen"></i><span>Edit (select)</span></div>
    <div class="ctx-item" data-action="duplicate"><i class="fas fa-clone"></i><span>Duplicate</span></div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" data-action="front"><i class="fas fa-arrow-up"></i><span>Bring to front</span></div>
    <div class="ctx-item" data-action="back"><i class="fas fa-arrow-down"></i><span>Send to back</span></div>
    <div class="ctx-sep"></div>
    <div class="ctx-item" data-action="changecolor"><i class="fas fa-palette"></i><span>Change color (cycle)</span></div>
    <div class="ctx-sep"></div>
    <div class="ctx-item danger" data-action="delete"><i class="fas fa-trash"></i><span>Delete</span></div>
  </div>

  <!-- EMBEDDED DATA (DO NOT MODIFY THIS SECTION MANUALLY) -->
  <script id="embeddedData" type="application/json">[]</script>

  <script>
  (function(){
    'use strict';

    // Elements
    const board = document.getElementById('board');
    const headingInput = document.getElementById('headingInput');
    const contentInput = document.getElementById('contentInput');
    const addBtn = document.getElementById('addBtn');
    const updateBtn = document.getElementById('updateBtn');
    const saveFileBtn = document.getElementById('saveFileBtn');
    const saveFloatToggle = document.getElementById('saveFloatToggle');

    const colorOptions = Array.from(document.querySelectorAll('.color-option'));
    const customColor = document.getElementById('customColor');

    const quickButtons = Array.from(document.querySelectorAll('.quick-btn'));

    const notification = document.getElementById('notification');
    const copyToast = document.getElementById('copyToast');

    const addPanel = document.getElementById('addPanel');
    const collapseToggle = document.getElementById('collapseToggle');

    const editInfo = document.getElementById('editInfo');
    const editIdSpan = document.getElementById('editId');
    const modeLabel = document.getElementById('modeLabel');

    const contextMenu = document.getElementById('contextMenu');

    const alignGuides = document.getElementById('alignGuides');
    const guideV = document.getElementById('guideV');
    const guideH = document.getElementById('guideH');

    const multiCopyBtn = document.getElementById('multiCopyBtn');
    const multiFloatToggle = document.getElementById('multiFloatToggle');
    const multiCopyPanel = document.getElementById('multiCopyPanel');
    const multiPanelHeader = document.getElementById('multiPanelHeader');
    const multiItemsList = document.getElementById('multiItemsList');
    const multiClearBtn = document.getElementById('multiClearBtn');

    // State
    const PRESET_COLORS = ['#6366f1','#ec4899','#f59e0b','#10b981','#3b82f6','#8b5cf6'];

    let selectedColor = '#6366f1';
    let selectedId = null;
    let contextTargetId = null;

    let maxZ = 1000;

    let multiCopyActive = false;
    let multiCopyItems = [];

    // Auto-hide
    let autoHideTimer = null;
    const AUTO_HIDE_MS = 5000;

    // Capture initial HTML for stable save
    const initialHtml = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;

    function notify(msg, type='success'){
      notification.textContent = msg;
      notification.style.background = type==='success' ? '#10b981' : (type==='error' ? '#ef4444' : '#3b82f6');
      notification.classList.add('show');
      setTimeout(()=>notification.classList.remove('show'), 2200);
    }

    function showCopyToastNearElement(el, text='Copied'){
      if(!el) return;
      const r = el.getBoundingClientRect();
      const pad = 8;
      const x = Math.min(window.innerWidth - 10, r.right + pad);
      const y = Math.max(10, r.top + (r.height/2) - 10);
      copyToast.textContent = text;
      copyToast.style.left = x + 'px';
      copyToast.style.top = y + 'px';
      copyToast.classList.add('show');
      clearTimeout(showCopyToastNearElement._t);
      showCopyToastNearElement._t = setTimeout(()=>copyToast.classList.remove('show'), 700);
    }

    function escapeHtml(text){
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    function clamp(val, min, max){
      return Math.max(min, Math.min(max, val));
    }

    function resetAutoHideTimer(){
      clearTimeout(autoHideTimer);
      if(!addPanel.classList.contains('collapsed')){
        autoHideTimer = setTimeout(()=>{
          addPanel.classList.add('collapsed');
          collapseToggle.classList.add('pulse');
          setTimeout(()=>collapseToggle.classList.remove('pulse'), 3000);
        }, AUTO_HIDE_MS);
      }
    }

    function showPanel(){
      addPanel.classList.remove('collapsed');
      collapseToggle.classList.remove('pulse');
      resetAutoHideTimer();
    }

    // Clipboard copy with fallback (works even in file://)
    async function copyText(text){
      const value = String(text ?? '');
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(value);
          return true;
        }
      }catch(e){/* fall back */}

      try{
        const ta = document.createElement('textarea');
        ta.value = value;
        ta.setAttribute('readonly','');
        ta.style.position='fixed';
        ta.style.left='-9999px';
        ta.style.top='0';
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      }catch(e){
        return false;
      }
    }

    function hideGuides(){
      guideV.classList.remove('show');
      guideH.classList.remove('show');
    }
    function showV(x){ guideV.style.left = x + 'px'; guideV.classList.add('show'); }
    function showH(y){ guideH.style.top = y + 'px'; guideH.classList.add('show'); }

    function getSnap(value, targets, threshold){
      let best = null;
      for(const t of targets){
        const d = Math.abs(value - t);
        if(d <= threshold && (!best || d < best.d)) best = {d, t};
      }
      if(!best) return { snapped:value, guide:null, d:Infinity };
      return { snapped:best.t, guide:best.t, d:best.d };
    }

    // Load items
    let items = [];
    function loadItems(){
      let embedded = [];
      try{ embedded = JSON.parse(document.getElementById('embeddedData').textContent || '[]'); }catch(e){ embedded = []; }

      let ls = [];
      try{ ls = JSON.parse(localStorage.getItem('clipboard_layout_items') || '[]'); }catch(e){ ls = []; }

      const use = (Array.isArray(embedded) && embedded.length) ? embedded : (Array.isArray(ls) ? ls : []);

      items = use.map(it => ({
        id: Number(it.id) || Date.now(),
        heading: String(it.heading ?? ''),
        content: String(it.content ?? ''),
        color: String(it.color || '#6366f1'),
        x: Number(it.x) || 20,
        y: Number(it.y) || 20,
        w: Number(it.w) || 140,
        h: Number(it.h) || 60,
        z: Number(it.z ?? it.zIndex ?? 1) || 1
      }));

      maxZ = 1000;
      for(const it of items){ if(it.z > maxZ) maxZ = it.z; }
    }

    function saveLayout(){ localStorage.setItem('clipboard_layout_items', JSON.stringify(items)); }

    function boardBounds(){
      const r = board.getBoundingClientRect();
      return { w: r.width, h: r.height };
    }

    function clearSelected(){
      selectedId = null;
      updateBtn.disabled = true;
      modeLabel.textContent = 'Mode: Add new';
      editInfo.style.display = 'none';
      editIdSpan.textContent = '';
    }

    function setSelected(id){
      selectedId = id;
      const item = items.find(it => it.id === selectedId);
      if(item){
        headingInput.value = item.heading;
        contentInput.value = item.content;
        selectedColor = item.color;
        customColor.value = item.color;
        colorOptions.forEach(o=>o.classList.toggle('selected', o.dataset.color === item.color));

        updateBtn.disabled = false;
        modeLabel.textContent = 'Mode: Edit selected';
        editInfo.style.display = 'block';
        editIdSpan.textContent = String(item.id);
      }else{
        clearSelected();
      }
    }

    function render(){
      board.querySelectorAll('.clipboard-item').forEach(el=>el.remove());
      for(const item of items){
        const el = document.createElement('div');
        el.className = 'clipboard-item' + (item.id===selectedId ? ' selected' : '');
        el.dataset.id = String(item.id);
        el.style.left = item.x + 'px';
        el.style.top = item.y + 'px';
        el.style.width = item.w + 'px';
        el.style.height = item.h + 'px';
        el.style.backgroundColor = item.color;
        el.style.zIndex = String(item.z);

        el.innerHTML = `
          <div class="copy-indicator">Copied</div>
          <button class="delete-btn" title="Delete"><i class="fas fa-times"></i></button>
          <div class="item-heading">${escapeHtml(item.heading).replace(/\n/g,'<br>')}</div>
          <div class="resize-handle" title="Resize"></div>
        `;

        board.appendChild(el);
      }
    }

    function addItem(heading, content){
      const c = String(content ?? '');
      if(!c.trim()){
        notify('Enter content (what to copy)', 'info');
        return;
      }
      const b = boardBounds();
      maxZ++;
      const id = Date.now();
      const item = {
        id,
        heading: (String(heading ?? '').trim()) ? String(heading).trim() : c.slice(0, 20),
        content: c,
        color: selectedColor,
        x: clamp(20 + (items.length*10) % Math.max(b.w-160,160), 0, Math.max(0,b.w-100)),
        y: clamp(20 + (items.length*10) % 140, 0, Math.max(0,b.h-40)),
        w: 140,
        h: 60,
        z: maxZ
      };
      items.push(item);
      saveLayout();
      clearSelected();
      headingInput.value = '';
      contentInput.value = '';
      render();
      notify('Box added', 'success');
      resetAutoHideTimer();
    }

    function updateSelected(){
      if(selectedId==null){
        notify('Select a box to edit', 'info');
        return;
      }
      const idx = items.findIndex(it => it.id === selectedId);
      if(idx < 0){
        clearSelected();
        render();
        return;
      }
      items[idx].heading = String(headingInput.value ?? '').trim() || items[idx].heading;
      items[idx].content = String(contentInput.value ?? '');
      items[idx].color = selectedColor;
      saveLayout();
      render();
      notify('Box updated', 'success');
      resetAutoHideTimer();
    }

    function deleteItem(id){
      items = items.filter(it => it.id !== id);
      if(selectedId === id) clearSelected();
      saveLayout();
      render();
      notify('Item deleted', 'info');
    }

    function duplicateItem(id){
      const src = items.find(it => it.id === id);
      if(!src) return;
      maxZ++;
      const copy = {
        ...src,
        id: Date.now(),
        x: src.x + 20,
        y: src.y + 20,
        z: maxZ
      };
      items.push(copy);
      saveLayout();
      render();
      notify('Item duplicated', 'success');
    }

    function bringToFront(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      maxZ++;
      it.z = maxZ;
      saveLayout();
      render();
    }

    function sendToBack(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      const minZ = Math.min(...items.map(x=>x.z||1));
      it.z = minZ - 1;
      saveLayout();
      render();
      notify('Sent to back', 'info');
    }

    function cycleColor(id){
      const it = items.find(x=>x.id===id);
      if(!it) return;
      const i = PRESET_COLORS.indexOf(it.color);
      it.color = PRESET_COLORS[(i+1+PRESET_COLORS.length) % PRESET_COLORS.length];
      saveLayout();
      render();
      notify('Color changed', 'success');
    }

    function showContextMenu(x,y,id){
      contextTargetId = id;
      contextMenu.classList.add('show');
      // Keep inside viewport
      const r = contextMenu.getBoundingClientRect();
      const maxX = window.innerWidth - r.width - 10;
      const maxY = window.innerHeight - r.height - 10;
      contextMenu.style.left = clamp(x, 8, maxX) + 'px';
      contextMenu.style.top = clamp(y, 8, maxY) + 'px';
    }

    function hideContextMenu(){
      contextMenu.classList.remove('show');
      contextTargetId = null;
    }

    function renderMultiList(){
      multiItemsList.innerHTML = '';
      for(const txt of multiCopyItems){
        const div = document.createElement('div');
        div.className = 'multi-item';
        div.textContent = txt;
        multiItemsList.appendChild(div);
      }
      if(multiCopyItems.length){
        const combined = multiCopyItems.join('\n');
        copyText(combined);
      }
    }

    function setMultiCopy(active){
      multiCopyActive = !!active;
      multiCopyPanel.classList.toggle('active', multiCopyActive);
      multiCopyBtn.classList.toggle('active', multiCopyActive);
      multiFloatToggle.classList.toggle('active', multiCopyActive);
      if(multiCopyActive){
        multiCopyBtn.innerHTML = '<i class="fas fa-stop-circle"></i>Stop Multi';
        multiFloatToggle.innerHTML = '<i class="fas fa-stop-circle"></i>';
        notify('Multi-Copy Mode ON', 'success');
      }else{
        multiCopyBtn.innerHTML = '<i class="fas fa-layer-group"></i>Multi Copy';
        multiFloatToggle.innerHTML = '<i class="fas fa-layer-group"></i>';
        multiCopyItems = [];
        renderMultiList();
        notify('Multi-Copy Mode OFF', 'info');
      }
      resetAutoHideTimer();
    }

    function saveToFile(){
      const parser = new DOMParser();
      const doc = parser.parseFromString(initialHtml, 'text/html');
      const script = doc.getElementById('embeddedData');
      if(script){
        script.textContent = JSON.stringify(items, null, 2);
      }
      const finalHtml = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      const blob = new Blob([finalHtml], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'clipboard-manager-' + new Date().toISOString().slice(0,10) + '.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      notify('HTML saved with ' + items.length + ' items', 'success');
      resetAutoHideTimer();
    }

    // ========= Interactions (board) =========

    let pointerMode = null; // 'drag' | 'resize'
    let pointerId = null;
    let start = null;
    let moved = false;

    function findItemEl(target){
      return target.closest('.clipboard-item');
    }

    board.addEventListener('pointerdown', (e)=>{
      const itemEl = findItemEl(e.target);
      if(!itemEl) return;

      const id = Number(itemEl.dataset.id);

      // Delete
      if(e.target.closest('.delete-btn')){
        e.preventDefault();
        deleteItem(id);
        return;
      }

      // Decide mode
      if(e.target.closest('.resize-handle')){
        pointerMode = 'resize';
      }else{
        pointerMode = 'drag';
      }

      pointerId = e.pointerId;
      itemEl.setPointerCapture(pointerId);

      const it = items.find(x=>x.id===id);
      if(!it) return;

      // Bring to front (without extra notify)
      maxZ++;
      it.z = maxZ;

      start = {
        id,
        startX: e.clientX,
        startY: e.clientY,
        x: it.x,
        y: it.y,
        w: it.w,
        h: it.h
      };
      moved = false;

      // Select on press
      setSelected(id);
      render();
    });

    board.addEventListener('pointermove', (e)=>{
      if(pointerId==null || e.pointerId !== pointerId || !start) return;
      const it = items.find(x=>x.id===start.id);
      if(!it) return;

      const dx = e.clientX - start.startX;
      const dy = e.clientY - start.startY;
      if(Math.abs(dx) > 2 || Math.abs(dy) > 2) moved = true;

      const b = boardBounds();

      if(pointerMode === 'drag'){
        // Alignment guides + snapping
        hideGuides();
        const threshold = 6;

        let nx = clamp(start.x + dx, 0, Math.max(0, b.w - it.w));
        let ny = clamp(start.y + dy, 0, Math.max(0, b.h - it.h));

        const w = it.w, h = it.h;
        const left = nx, right = nx + w, cx = nx + w/2;
        const top = ny, bottom = ny + h, cy = ny + h/2;

        // targets include board center + other items edges/centers
        const xTargets = [b.w/2];
        const yTargets = [b.h/2];
        for(const other of items){
          if(other.id === it.id) continue;
          xTargets.push(other.x, other.x + other.w/2, other.x + other.w);
          yTargets.push(other.y, other.y + other.h/2, other.y + other.h);
        }

        // snap X using L/C/R best
        const sL = getSnap(left, xTargets, threshold);
        const sC = getSnap(cx, xTargets, threshold);
        const sR = getSnap(right, xTargets, threshold);

        let bestX = {d: Infinity, nx: nx, guide: null};
        if(sL.guide != null && sL.d < bestX.d) bestX = {d:sL.d, nx:sL.snapped, guide:sL.guide};
        if(sC.guide != null && sC.d < bestX.d) bestX = {d:sC.d, nx:sC.snapped - w/2, guide:sC.guide};
        if(sR.guide != null && sR.d < bestX.d) bestX = {d:sR.d, nx:sR.snapped - w, guide:sR.guide};
        if(bestX.guide != null){
          nx = clamp(bestX.nx, 0, Math.max(0, b.w - w));
          showV(bestX.guide);
        }

        // snap Y using T/C/B best
        const sT = getSnap(top, yTargets, threshold);
        const sM = getSnap(cy, yTargets, threshold);
        const sB = getSnap(bottom, yTargets, threshold);

        let bestY = {d: Infinity, ny: ny, guide: null};
        if(sT.guide != null && sT.d < bestY.d) bestY = {d:sT.d, ny:sT.snapped, guide:sT.guide};
        if(sM.guide != null && sM.d < bestY.d) bestY = {d:sM.d, ny:sM.snapped - h/2, guide:sM.guide};
        if(sB.guide != null && sB.d < bestY.d) bestY = {d:sB.d, ny:sB.snapped - h, guide:sB.guide};
        if(bestY.guide != null){
          ny = clamp(bestY.ny, 0, Math.max(0, b.h - h));
          showH(bestY.guide);
        }

        it.x = nx;
        it.y = ny;

      }else if(pointerMode === 'resize'){
        const w = Math.max(100, start.w + dx);
        const h = Math.max(40, start.h + dy);
        it.w = w;
        it.h = h;
      }

      // fast update
      const el = board.querySelector(`.clipboard-item[data-id="${start.id}"]`);
      if(el){
        el.style.left = it.x + 'px';
        el.style.top = it.y + 'px';
        el.style.width = it.w + 'px';
        el.style.height = it.h + 'px';
      }
    });

    board.addEventListener('pointerup', async (e)=>{
      if(pointerId==null || e.pointerId !== pointerId || !start) return;

      const it = items.find(x=>x.id===start.id);
      pointerId = null;
      pointerMode = null;

      if(it){
        saveLayout();
      }

      // If it was a click (not dragged/resized), copy content and show toast near clicked item.
      if(it && !moved){
        const ok = await copyText(it.content || '');
        const el = board.querySelector(`.clipboard-item[data-id="${it.id}"]`);
        if(el){
          el.classList.add('copied');
          setTimeout(()=>el.classList.remove('copied'), 600);
          showCopyToastNearElement(el, multiCopyActive ? 'Added' : 'Copied');
        }

        if(multiCopyActive){
          multiCopyItems.push(it.content || '');
          renderMultiList();
          notify(ok ? 'Added to multi-copy' : 'Added (copy blocked)', ok ? 'success' : 'info');
        }else{
          // Keep global notification, but main visible feedback is toast near item
          if(!ok) notify('Copy blocked by browser. Use Ctrl+C.', 'info');
        }
      }

      hideGuides();
      start = null;
    });

    board.addEventListener('contextmenu', (e)=>{
      const itemEl = findItemEl(e.target);
      if(!itemEl) return;
      e.preventDefault();
      const id = Number(itemEl.dataset.id);
      showContextMenu(e.clientX, e.clientY, id);
    });

    document.addEventListener('mousedown', (e)=>{
      if(!contextMenu.classList.contains('show')) return;
      if(e.target.closest('#contextMenu')) return;
      hideContextMenu();
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') hideContextMenu();
    });

    // Context menu actions
    contextMenu.addEventListener('click', async (e)=>{
      const item = e.target.closest('.ctx-item');
      if(!item) return;
      const action = item.dataset.action;
      const id = contextTargetId;
      hideContextMenu();
      if(!id) return;

      if(action === 'copy'){
        const it = items.find(x=>x.id===id);
        if(it){
          const ok = await copyText(it.content || '');
          const el = board.querySelector(`.clipboard-item[data-id="${id}"]`);
          showCopyToastNearElement(el, 'Copied');
          if(!ok) notify('Copy blocked by browser. Use Ctrl+C.', 'info');
        }
      }
      else if(action === 'edit'){
        setSelected(id);
        showPanel();
        render();
      }
      else if(action === 'duplicate') duplicateItem(id);
      else if(action === 'delete') deleteItem(id);
      else if(action === 'front') { bringToFront(id); notify('Brought to front', 'info'); }
      else if(action === 'back') sendToBack(id);
      else if(action === 'changecolor') cycleColor(id);
    });

    // Panel and form events
    collapseToggle.addEventListener('click', ()=>{
      const wasCollapsed = addPanel.classList.contains('collapsed');
      addPanel.classList.toggle('collapsed');
      collapseToggle.classList.remove('pulse');
      if(wasCollapsed) resetAutoHideTimer();
      else clearTimeout(autoHideTimer);
    });

    // Reset timer on panel interactions
    const panelWrapper = document.querySelector('.add-panel-wrapper');
    ['mousemove','mouseenter','click','keydown','input','change','scroll'].forEach(evt => {
      panelWrapper.addEventListener(evt, resetAutoHideTimer);
    });

    colorOptions.forEach(opt=>{
      opt.addEventListener('click', ()=>{
        colorOptions.forEach(o=>o.classList.remove('selected'));
        opt.classList.add('selected');
        selectedColor = opt.dataset.color;
        customColor.value = selectedColor;
        resetAutoHideTimer();
      });
    });

    customColor.addEventListener('input', (e)=>{
      selectedColor = e.target.value;
      colorOptions.forEach(o=>o.classList.remove('selected'));
      resetAutoHideTimer();
    });

    addBtn.addEventListener('click', ()=> addItem(headingInput.value, contentInput.value));
    contentInput.addEventListener('keydown', (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key === 'Enter') addItem(headingInput.value, contentInput.value);
    });

    updateBtn.addEventListener('click', updateSelected);

    saveFileBtn.addEventListener('click', saveToFile);
    saveFloatToggle.addEventListener('click', saveToFile);

    quickButtons.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        addItem(btn.dataset.heading, btn.dataset.content);
      });
    });

    // Multi-copy
    function toggleMulti(){ setMultiCopy(!multiCopyActive); }
    multiCopyBtn.addEventListener('click', toggleMulti);
    multiFloatToggle.addEventListener('click', toggleMulti);

    multiClearBtn.addEventListener('click', async ()=>{
      multiCopyItems = [];
      renderMultiList();
      await copyText('');
      notify('Multi-copy list cleared', 'info');
    });

    // Draggable multi panel
    let mpDrag = null;
    multiPanelHeader.addEventListener('pointerdown', (e)=>{
      mpDrag = { x: e.clientX, y: e.clientY, rect: multiCopyPanel.getBoundingClientRect(), pid: e.pointerId };
      multiPanelHeader.setPointerCapture(e.pointerId);
    });
    multiPanelHeader.addEventListener('pointermove', (e)=>{
      if(!mpDrag || e.pointerId !== mpDrag.pid) return;
      const dx = e.clientX - mpDrag.x;
      const dy = e.clientY - mpDrag.y;
      let left = mpDrag.rect.left + dx;
      let top = mpDrag.rect.top + dy;
      left = clamp(left, 0, window.innerWidth - multiCopyPanel.offsetWidth);
      top = clamp(top, 0, window.innerHeight - multiCopyPanel.offsetHeight);
      multiCopyPanel.style.left = left + 'px';
      multiCopyPanel.style.top = top + 'px';
      multiCopyPanel.style.right = 'auto';
      multiCopyPanel.style.transform = 'none';
    });
    multiPanelHeader.addEventListener('pointerup', ()=>{ mpDrag = null; });

    // Clear all shortcut
    document.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='x'){
        if(!items.length) return;
        if(confirm(`Delete all ${items.length} items?`)){
          items = [];
          saveLayout();
          clearSelected();
          render();
          notify('All items deleted', 'info');
        }
      }
    });

    // Init
    loadItems();
    render();
    resetAutoHideTimer();

  })();
  </script>
</body>
</html>
